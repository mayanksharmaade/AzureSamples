using Azure.Messaging.ServiceBus;

const string BusConnectionstring = "Endpoint=sb://mayankservicebus.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=ERuAplr7wxWBmWTxvUmGXTuASJqm8SrH3+ASbFv8fgs=";
const string QueueName = "mayankservicebus-queue-1";



ServiceBusClient client;
ServiceBusProcessor processor = default!;

async Task MessageHandler(ProcessMessageEventArgs Messageargs)
{
    string body = Messageargs.Message.Body.ToString();
    Console.WriteLine(body);
    await Messageargs.CompleteMessageAsync(Messageargs.Message);
}

 Task ErrorHandler(ProcessErrorEventArgs ErrorArgs)
{
    Console.WriteLine(ErrorArgs.Exception.ToString());
    return Task.CompletedTask;
}

client = new ServiceBusClient(BusConnectionstring);
processor = client.CreateProcessor(QueueName, new ServiceBusProcessorOptions());

try {
    processor.ProcessMessageAsync += MessageHandler;
    processor.ProcessErrorAsync += ErrorHandler;

    await processor.StartProcessingAsync();
    Console.WriteLine("Press a key to strop the processor.");
    Console.ReadKey();
}
catch (Exception ex)
{
    throw;
}

finally {
    await processor.DisposeAsync();
    await client.DisposeAsync();
